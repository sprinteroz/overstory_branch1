{"type":"decision","title":"Custom SQLite Mail over Beads","rationale":"Mail is high-frequency (agents poll every prompt via hooks). bd CLI at 50-200ms too slow for 10+ agents. SQLite via bun:sqlite gives 1-5ms queries. Beads owns tasks, mail owns communication. Independent failure domains.","classification":"foundational","recorded_at":"2026-02-12T15:18:14.233Z","tags":["sqlite","mail","performance"],"id":"mx-04e745"}
{"type":"convention","content":"Mail client operations that take a message ID should always validate existence before acting. The store layer (L1) is intentionally lenient (SQLite UPDATE on missing row is a no-op), but the client layer (L2) must enforce existence checks and throw MailError with the messageId in context. Validate enum-like CLI inputs (type, priority) at the command layer before casting with 'as', using a const array of valid values and includes() check.","classification":"tactical","recorded_at":"2026-02-12T16:43:56.188Z","id":"mx-7170fd"}
{"type":"pattern","name":"SQLite CHECK constraint migration","description":"Schema migration for CHECK constraints in SQLite: Since SQLite doesn't support ALTER TABLE ADD CONSTRAINT, migrate by renaming old table, creating new table with constraints, copying data with CASE expressions to sanitize invalid values to defaults, then dropping the old table. Wrap in a transaction. Gate migration on inspecting sqlite_master.sql for existing CHECK keyword presence.","classification":"tactical","recorded_at":"2026-02-12T17:50:11.295Z","id":"mx-29a023"}
{"type":"failure","description":"mail reply routed to self when replier was the original sender: reply() always set to=original.from, but when from===original.from the reply goes back to yourself.","resolution":"Determine recipient dynamically: if from===original.from, reply to original.to; otherwise reply to original.from.","classification":"tactical","recorded_at":"2026-02-12T19:52:03.647Z","id":"mx-cce8e7"}
{"type":"failure","description":"mail list --unread appeared broken during E2E testing because mail check was run first, which marks messages as read as a side effect. Users expected mail check to be read-only but it silently mutates state.","resolution":"Added --agent flag to mail list as alias for --to, giving agent-scoped perspective without marking read. For debugging, use mail list --agent X --unread instead of mail check.","classification":"tactical","recorded_at":"2026-02-12T19:52:09.911Z","id":"mx-afabf2"}
{"type":"pattern","name":"typed-mail-protocol","description":"Phase 0 typed mail protocol: Extended MailMessage.type with 8 protocol types (worker_done, merge_ready, merged, merge_failed, escalation, health_check, dispatch, assign). Added nullable payload column (TEXT) for JSON-serialized structured data. Store.insert() accepts optional payload (defaults null) for backward compatibility. Client adds sendProtocol<T>() for type-safe serialization and parsePayload<T>() for deserialization.","classification":"tactical","recorded_at":"2026-02-12T22:01:17.757Z","id":"mx-61dd81"}
{"type":"convention","content":"Mail is for short notifications/status, not file transport. Scouts write specs to files via overstory spec write, then send a short notification mail with the file path. SPEC_VIA_MAIL failure mode enforces this.","classification":"tactical","recorded_at":"2026-02-13T20:41:47.292Z","id":"mx-f497f4"}
{"type":"pattern","name":"auto-nudge-protocol-types","description":"Mail auto-nudge fires for both priority-based (urgent/high) and protocol-type-based (worker_done, merge_ready, error, escalation, merge_failed) messages. AUTO_NUDGE_TYPES set in mail.ts controls which protocol types trigger nudge regardless of priority.","classification":"tactical","recorded_at":"2026-02-13T22:38:25.102Z","id":"mx-382a07"}
{"type":"decision","title":"Auto-nudge via pending marker files instead of tmux sendKeys","rationale":"tmux sendKeys during tool execution corrupts agent I/O, causing SIGKILL (exit 137) and request interrupted errors","classification":"tactical","recorded_at":"2026-02-14T02:49:07.256Z","id":"mx-728f8d"}
{"type":"decision","title":"Pending-nudge markers replace tmux sendKeys for auto-nudge","rationale":"tmux sendKeys during tool execution corrupts agent I/O (SIGKILL exit 137). Marker files are read safely by UserPromptSubmit hook between tool executions.","classification":"tactical","recorded_at":"2026-02-14T03:08:47.841Z","id":"mx-67dbd7"}
{"type":"pattern","name":"mail-check-debounce","description":"Mail check debounce pattern: Uses .overstory/mail-check-state.json to track last check timestamps per agent. isDebounced() checks if within window, recordCheck() updates timestamp. Silent skip when debounced (no output). Pattern follows same approach as nudge.ts debouncing.","classification":"tactical","recorded_at":"2026-02-15T20:43:35.529Z","id":"mx-b2e7e6"}
