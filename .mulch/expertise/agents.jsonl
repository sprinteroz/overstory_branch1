{"type":"pattern","name":"Agent Lifecycle: Sling-Execute-Close","description":"Agent spawn: overstory sling creates worktree + overlay CLAUDE.md + hooks + tmux session. Agent reads base def + overlay, executes task. Agent reports completion via bd close. Worktree cleaned after merge. Branch naming: overstory/{agentName}/{beadId}.","classification":"foundational","recorded_at":"2026-02-12T15:18:28.885Z","tags":["lifecycle","sling","worktree"],"id":"mx-389460"}
{"type":"pattern","name":"State reconciliation in status display","description":"When displaying agent status, reconcile recorded state with actual tmux session existence. If tmux session is dead but agent state is booting/working, mark as zombie and persist the correction to sessions.json. This prevents stale states from misleading the orchestrator.","classification":"tactical","recorded_at":"2026-02-12T16:32:50.002Z","id":"mx-1c2df8"}
{"type":"pattern","name":"PATH injection for tmux-spawned agents","description":"When creating tmux sessions for agents, detect the overstory binary directory via 'which overstory' (or fallback to process.argv[0] dirname) and prepend it to PATH in the tmux command wrapper. This ensures hooks inside agent sessions can find the overstory CLI.","classification":"tactical","recorded_at":"2026-02-12T16:32:55.639Z","id":"mx-2e4365"}
{"type":"pattern","name":"Session lastActivity update in hooks","description":"log.ts tool-start and tool-end events update the agent lastActivity timestamp in sessions.json. session-end calls updateIdentity to increment sessionsCompleted and record completed task. All updates are non-fatal to avoid breaking hook execution.","classification":"tactical","recorded_at":"2026-02-12T16:33:32.203Z","id":"mx-6f17c5"}
{"type":"pattern","name":"Worktree cleanup: separate force flags and zombie pruning","description":"Worktree cleanup lifecycle: separate force flags for worktree removal (handles untracked files) and branch deletion (handles unmerged branches) via forceBranch option. Agent branches are typically unmerged when cleaned, so cleanup should always force-delete branches. Session pruning uses worktree path existence as the source of truth for whether a zombie entry is stale.","classification":"tactical","recorded_at":"2026-02-12T16:44:56.427Z","id":"mx-03059d"}
{"type":"pattern","name":"Env var injection via tmux createSession","description":"createSession() in worktree/tmux.ts accepts an optional env Record<string, string> parameter. Env vars are exported as shell statements prepended to the wrapped command. Used to set OVERSTORY_AGENT_NAME so agent definitions can reference it. All agent base .md files expect this var â€” always pass it from sling.","classification":"tactical","recorded_at":"2026-02-12T16:47:24.935Z","id":"mx-191c37"}
{"type":"pattern","name":"Force-remove agent worktrees on cleanup","description":"Agent worktrees always contain untracked .claude/ files (overlay CLAUDE.md + settings.local.json) deployed by sling. Non-forced git worktree remove fails on these. Always use force:true in removeWorktree for agent cleanup.","classification":"tactical","recorded_at":"2026-02-12T17:51:20.723Z","evidence":{"issue":"overstory-bhz"},"id":"mx-618c1b"}
{"type":"pattern","name":"Agent state transition via log events","description":"Log events (tool-start, tool-end) should transition agent state from booting to working. Without this, agents permanently stuck at booting unless watchdog runs. updateLastActivity in log.ts must also set state='working' when state='booting'.","classification":"tactical","recorded_at":"2026-02-12T17:52:34.144Z","evidence":{"issue":"overstory-51t"},"id":"mx-7478dc"}
{"type":"pattern","name":"Initial task prompt via tmux send-keys","description":"After sling creates a tmux session running Claude Code, it must send an initial prompt via sendKeys() to tell the agent to read its assignment and begin working. Without this, the agent sits idle at the REPL.","classification":"tactical","recorded_at":"2026-02-12T17:52:37.125Z","evidence":{"issue":"overstory-lx9"},"id":"mx-c58de8"}
{"type":"pattern","name":"read-only-overlay-gating","description":"overlay.ts uses a READ_ONLY_CAPABILITIES set (scout, reviewer) to conditionally render quality gates and constraints sections. Read-only agents get a lightweight Completion section instead of full quality gates. The capability field was added to OverlayConfig. Template uses {{QUALITY_GATES}} and {{CONSTRAINTS}} placeholders.","classification":"tactical","recorded_at":"2026-02-12T19:47:40.508Z","id":"mx-f8bf2d"}
{"type":"decision","title":"Headless mode initial state is working not booting","rationale":"Since agents are spawned in headless mode (claude -p) where hooks do not fire, the booting->working transition in log.ts never occurs. sling.ts now sets initial state to working at spawn time. The booting state is only meaningful for interactive mode.","classification":"tactical","recorded_at":"2026-02-12T19:47:46.123Z","id":"mx-e0f870"}
{"type":"failure","description":"Headless mode (claude -p) disables all Claude Code hooks, breaking: mail check injection, log events, session metrics, and lastActivity updates.","resolution":"Options: (1) switch from claude -p to interactive mode with sendKeys, (2) build hook-free alternatives (e.g., periodic mail polling in prompt, metrics recorded by sling/watchdog instead of hooks), (3) use claude --hooks flag if available.","classification":"tactical","recorded_at":"2026-02-12T20:11:49.450Z","id":"mx-7fd64a"}
{"type":"failure","description":"Sling must pass --model from agent manifest to claude CLI. Without it, all agents use default model, defeating cost optimization (scouts=haiku) and capability matching (leads=opus).","resolution":"Added --model ${agentDef.model} flag to the claude command string in sling.ts line 312, reading the model from the loaded agent manifest entry.","classification":"tactical","recorded_at":"2026-02-12T20:15:46.380Z","id":"mx-aa807d"}
